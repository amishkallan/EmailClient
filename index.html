<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
  <title>Email Client</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>

<body>
  <div class="jumbotron text-center">
    <h1>Email Client</h1>
    <p>connect your outlook account to view your emails here!</p>
    <!-- <a id = 'fetchLink' href="/auth/outlook">Connect Outlook</a> -->
    <button onclick=connectOutlook() class="btn btn-primary">Connect Outlook</button>
    <button onclick=fetchEmails() class="btn btn-primary">Refresh</button>
    <button onclick=logout() class="btn btn-info">logout</button>
    <h2 id='user-info'>Hey, Pls login</h2>
    <div id = 'spinner-outer' >
      <div class="spinner-border" id="spinner" role="status">
        <span class="sr-only">Loading...</span>
      </div>
      <a id = "percentage"></a>
    </div>

  </div>
  <div>
    <table id="email-table" class="table table-striped">
      <thead>
        <tr>
          <th scope="col">Subject</th>
          <th scope="col">sender</th>
          <th scope="col">Opened</th>
          <th scope="col">Flagged</th>
          <th scope="col">Received</th>
        </tr>
      </thead>
      
    </table>
  </div>

  <script>
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      // console.log(parts);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function displayName(){
      // Display user info if available in the cookie
      try {
        const userCookie = getCookie('userprofile');
        if (userCookie) {
          const user = JSON.parse(decodeURIComponent(userCookie));
          document.getElementById('user-info').innerText = 'Welcome, ' + user.name;
        } else {
          document.getElementById('user-info').innerText = 'Hey, Pls login';
        }
      } catch (error) {
        alert('User not logged in');
      }
    }

    function connectOutlook() {
      window.location.href = '/auth/outlook';
    }


    // Function to generate table rows
    const generateTableRows = (emailList) => {

      return emailList.map(row => `
        <tr>
          <th scope="row">${row.subject == '' ? '(No Subject)' : row.subject}</th>
          <td>${row.sender.emailAddress.name}</td>
          <td>${row.isRead ? 'Read' : 'Unread'}</td>
          <td>${row.flag}</td>
          <td>${new Date(row.receivedDateTime).toLocaleString()}</td>
          <td>${row.isDeleted ? 'Deleted' : 'Not Deleted'}</td>
        </tr>`).join('');
    };

    async function fetchEmails() {
      try {
        console.log("starting fetch emails")
        const token = getCookie('accessToken');
        const emailId = getCookie('userId')
        console.log("token : ", token)
        const res = await fetch('/emails', {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + token,
            'email': emailId
          }
        });
        const emails = await res.json();
        console.log("emails : ", emails)
        const emailTableEle = document.getElementById('email-table');
        const generateTable = (emails) => {
          console.log("inner tag : ", emails)
          return `
          <thead class="thead-light">
            <tr>
              <th scope="col">Subject</th>
              <th scope="col">sender</th>
              <th scope="col">Opened</th>
              <th scope="col">Flagged</th>
              <th scope="col">Received</th>
              <th scope="col">Deleted</th>
            </tr>
          </thead>
          <tbody>
            ${generateTableRows(emails)}
          </tbody>`
        }
        // console.log("generateTable(data) :", generateTable(emails))
        emailTableEle.innerHTML = generateTable(emails);
      } catch (error) {
        console.log("emails got into error")
        alert('User not logged in. Please Login via Outlook');
        return `
          <thead class="thead-light">
            <tr>
              <th scope="col">Subject</th>
              <th scope="col">sender</th>
              <th scope="col">Opened</th>
              <th scope="col">Flagged</th>
              <th scope="col">Received</th>
              <th scope="col">Deleted</th>
            </tr>
          </thead>
            `
      }
    }

    async function checkStatus() {
      const spinner = document.getElementById("spinner");
      const spinner_outer = document.getElementById('percentage')
      try{
        
        spinner.style.display = 'block';
        spinner_outer.style.display = 'block'

        const res = await fetch('/insertStatus', {
            method: 'GET',
            headers: {
              'Authorization': 'Bearer '
            }
          });
        
        // if (res.)
        
        const data = await res.json();
        console.log(" res : ",data)
        const emailInsertStatus = data.userData.InsertStatus

        // const emailInsertStatus = getCookie("emailInsertStatus");
        console.log("emailInsertStatus : ", emailInsertStatus)
        if (emailInsertStatus && emailInsertStatus < 100) {
          spinner_outer.innerText = "sync cpmlpeted : "+emailInsertStatus + "%";
          setTimeout(checkStatus, 1000)
        }
        else {
          spinner.style.display = "none";
          spinner_outer.style.display = "none"
          // setTimeout(checkStatus, 100)
          clearTimeout(interval);

        }
        await fetchEmails()
         
      } catch(error){
        clearTimeout(interval);
        spinner.style.display = "none";
        spinner_outer.style.display = "none"
      }

    }
    
    function logout() {
      fetch('/logout');
      window.location.href = '/';
      spinner.style.display = "none";
      spinner_outer.style.display = "none"

    }


    displayName();
    const interval = setTimeout(checkStatus, 3000);

  </script>
</body>

</html>